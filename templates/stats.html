<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <title>Datenbank Statistik – Übersicht</title>
    <!-- Bootstrap CSS (v4.5) -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- DataTables Bootstrap4 CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
    <!-- Custom CSS -->
    <style>
      body {
        padding-top: 70px; 
        background: #f8f9fa;
      }
      /* Navbar with gradient and shadow */
      .navbar {
        background: linear-gradient(45deg, #007bff, #00c6ff);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .navbar-brand, .nav-link {
        font-weight: bold;
        color: #fff !important;
      }
      .navbar-brand:hover, .nav-link:hover {
        color: #ffd700 !important;
      }
      /* Card styling with subtle shadow and transition */
      .card {
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        transition: transform 0.2s;
      }
      .card:hover {
        transform: translateY(-3px);
      }
      .chart-container {
        height:50vh;
        width:90vw;
        margin: auto;
      }
      table th, table td {
        text-align: center;
      }
      table th.missing {
        font-size: 0.8rem;
        color: red;
      }
    </style>
    <!-- Neues Script: vis-network (für Netzwerkanzeige) -->
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
      <a class="navbar-brand" href="#">DB Statistik</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" 
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="/stats">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/delete_table">Tabelle löschen</a>
          </li>
        </ul>
      </div>
    </nav>
    
    <div class="container-fluid">
      <h1 class="mb-4 text-center">Datenbank Statistik</h1>
      
      <!-- Integrity Status Field with Details Button -->
      <div id="integrityStatus" class="alert" role="alert">
        <!-- JavaScript will fill this in on page load -->
      </div>
      
      <!-- New button to toggle dpa authors filter -->
      <div class="text-center mb-3">
        <button id="toggleDpaBtn" class="btn btn-secondary">Autoren "dpa" ausblenden</button>
      </div>
      
      <!-- Error Details Modal -->
      <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title" id="errorModalLabel">Integritätsfehler Details</h5>
              <button type="button" class="close text-white" data-dismiss="modal" aria-label="Schließen">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body" id="errorDetails">
              <!-- Details populated by JS -->
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Prominente Anzeige der Gesamtzeilen (Artikel) -->
      <div class="card mb-4">
        <div class="card-body text-center">
          <h1 class="display-4 text-primary">
            Alle gecrawlten Artikel: {{ quality_stats['articles'].total }}
          </h1>
        </div>
      </div>
      
      <!-- New Chart: Top Autoren pro Kategorie (Artikel) -->
      <div class="card mb-4">
        <div class="card-header">
          Top Autoren pro Kategorie (Artikel)
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="authorCategoryChart"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Neues Diagramm: Top Autor pro Kategorie -->
      <div class="card mb-4">
        <div class="card-header">
          Top Autor pro Kategorie
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="topAuthorChart"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Statt Tabellenanzeige: Hinweis -->
      <div class="card mb-4">
        <div class="card-body text-center">
          <p class="text-muted">Tabellenanzeige wurde deaktiviert.</p>
        </div>
      </div>

      <!-- Entfernte Tabellenanzeige-Block -->
      {# 
      {% for table_name, rows in data.items() %}
        ...existing code for table rendering...
      {% endfor %}
      #}
      
      <!-- Neues Diagramm: Autorenverbindungen Netzwerk -->
      <div class="card mb-4">
        <div class="card-header">
          Autorenverbindungen
        </div>
        <div class="card-body">
          <div id="authorNetwork" style="height: 50vh;"></div>
        </div>
      </div>
      
    </div>
    
    <!-- JS: jQuery, Popper, Bootstrap, DataTables and Chart.js -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      $(document).ready(function() {
          $('table.datatable').DataTable({
              ordering: true,
              paging: true
          });
      });
      
      // Integrity Check via JavaScript:
      window.addEventListener('load', function() {
          let integrityMessages = [];
          let detailedMessages = []; // For modal details
          const articles = {{ data.articles | tojson }};
          if (articles && articles.length > 0) {
              let titleDateArray = articles.map(a => a.title + '|' + (a.date ? a.date : ''));
              let uniqueTitleDates = new Set(titleDateArray);
              if (titleDateArray.length !== uniqueTitleDates.size) {
                  integrityMessages.push("Warnung: Duplikate erkennen (gleicher Titel und Datum) gefunden.");
                  let duplicates = titleDateArray.filter((item, index) => titleDateArray.indexOf(item) !== index);
                  detailedMessages.push("Duplizierte Titel+Daten: " + Array.from(new Set(duplicates)).join(", "));
              }
              let validDates = articles.filter(a => a.date && a.date !== "N/A");
              if(validDates.length === 0) {
                  integrityMessages.push("Warnung: Keine gültigen Veröffentlichungsdaten gefunden.");
                  detailedMessages.push("Es wurden keine Artikel mit gültigen Datumsangaben gefunden.");
              }
          } else {
              integrityMessages.push("Warnung: Keine Artikeldaten vorhanden.");
              detailedMessages.push("Die Artikeldaten konnten nicht geladen werden.");
          }
          
          let statusDiv = document.getElementById('integrityStatus');
          if (integrityMessages.length > 0) {
              statusDiv.className = "alert alert-danger";
              statusDiv.innerHTML = integrityMessages.join("<br>") +
                  '<br><button id="showDetailsBtn" class="btn btn-sm btn-outline-light mt-2">Fehlerdetails anzeigen</button>';
              document.getElementById('showDetailsBtn').addEventListener('click', function() {
                  document.getElementById('errorDetails').innerHTML = detailedMessages.join("<br>");
                  $('#errorModal').modal('show');
              });
          } else {
              statusDiv.className = "alert alert-success";
              statusDiv.innerHTML = "Alle Integritätstests erfolgreich.";
          }
      });
      
      // Initialize filter flag from localStorage (default false)
      let hideDpa = (localStorage.getItem("hideDpa") === "true");
      // Update button text based on current state
      document.addEventListener("DOMContentLoaded", function(){
        const btn = document.getElementById("toggleDpaBtn");
        btn.textContent = hideDpa ? 'Autoren "dpa" einblenden' : 'Autoren "dpa" ausblenden';
      });
      
      // Helper function to split authors and filter out "dpa" names when needed
      function filterAuthors(authorStr) {
         let authors = authorStr.split(',').map(a => a.trim()).filter(Boolean);
         if (hideDpa) {
             authors = authors.filter(a => !/^(dpa|mit Material der dpa)$/i.test(a));
         }
         return authors;
      }
      
      // Toggle dpa filter button event
      document.getElementById("toggleDpaBtn").addEventListener("click", function(){
         hideDpa = !hideDpa;
         localStorage.setItem("hideDpa", hideDpa);
         this.textContent = hideDpa ? 'Autoren "dpa" einblenden' : 'Autoren "dpa" ausblenden';
         location.reload();
      });
      
      // Build the stacked bar chart for Top Autoren pro Kategorie
      const authorsSet = new Set();
      const categoriesSet = new Set();
      const articles = {{ data.articles | tojson }};
      
      articles.forEach(row => {
          if(row.author && row.category) {
              let authorsList = filterAuthors(row.author);
              if(authorsList.length > 0) {
                  authorsList.forEach(a => authorsSet.add(a));
              }
              categoriesSet.add(row.category);
          }
      });
      const authors = Array.from(authorsSet);
      const categories = Array.from(categoriesSet);
      
      const counts = {};
      categories.forEach(cat => {
          counts[cat] = new Array(authors.length).fill(0);
      });
      articles.forEach(row => {
          const category = row.category;
          if(row.author && category) {
              let authorsList = filterAuthors(row.author);
              authorsList.forEach(author => {
                  const idx = authors.indexOf(author);
                  if(idx !== -1) {
                      counts[category][idx] += 1;
                  }
              });
          }
      });
      
      const datasets = [];
      categories.forEach(cat => {
          const r = Math.floor(Math.random() * 156) + 100;
          const g = Math.floor(Math.random() * 156) + 100;
          const b = Math.floor(Math.random() * 156) + 100;
          datasets.push({
              label: cat,
              data: counts[cat],
              backgroundColor: `rgba(${r}, ${g}, ${b}, 0.6)`,
              borderColor: `rgba(${r}, ${g}, ${b}, 1)`,
              borderWidth: 1
          });
      });
      
      const ctx = document.getElementById('authorCategoryChart').getContext('2d');
      new Chart(ctx, {
          type: 'bar',
          data: {
              labels: authors,
              datasets: datasets
          },
          options: {
              responsive: true,
              plugins: {
                  tooltip: { mode: 'index', intersect: false },
                  legend: { position: 'top' }
              },
              scales: {
                  x: { stacked: true },
                  y: { stacked: true, beginAtZero: true }
              }
          }
      });
      
      // [REMOVED] --- Kategorie Diagramm und Editor pro Kategorie Chart Code block removed ---
      /*
      const categoryCounts = {};
      articles.forEach(row => {
          if (row.category) {
              categoryCounts[row.category] = (categoryCounts[row.category] || 0) + 1;
          }
      });
      const catLabels = Object.keys(categoryCounts);
      const catData = Object.values(categoryCounts);
      const catColors = catLabels.map(() => {
          const r = Math.floor(Math.random() * 256);
          const g = Math.floor(Math.random() * 256);
          const b = Math.floor(Math.random() * 256);
          return `rgba(${r}, ${g}, ${b}, 0.6)`;
      });
      const ctxCat = document.getElementById('categoryChart').getContext('2d');
      new Chart(ctxCat, {
          type: 'pie',
          data: {
              labels: catLabels,
              datasets: [{
                  data: catData,
                  backgroundColor: catColors
              }]
          },
          options: { responsive: true }
      });
      
      const categoryEditorData = {};
      articles.forEach(row => {
          if (row.category && row.editor_abbr) {
              if (!categoryEditorData[row.category]) {
                  categoryEditorData[row.category] = {};
              }
              categoryEditorData[row.category][row.editor_abbr] = (categoryEditorData[row.category][row.editor_abbr] || 0) + 1;
          }
      });
      const catELabels = [];
      const maxCounts = [];
      const maxEditors = [];
      for (let cat in categoryEditorData) {
          catELabels.push(cat);
          let editors = categoryEditorData[cat];
          let maxCount = 0, maxEditor = "";
          for (let ed in editors) {
              if (editors[ed] > maxCount) {
                  maxCount = editors[ed];
                  maxEditor = ed;
              }
          }
          maxCounts.push(maxCount);
          maxEditors.push(maxEditor);
      }
      const ctxEditorCat = document.getElementById('editorCategoryChart').getContext('2d');
      new Chart(ctxEditorCat, {
          type: 'bar',
          data: {
              labels: catELabels,
              datasets: [{
                  label: 'Artikelanzahl',
                  data: maxCounts,
                  backgroundColor: catELabels.map(() => {
                      const r = Math.floor(Math.random() * 256);
                      const g = Math.floor(Math.random() * 256);
                      const b = Math.floor(Math.random() * 256);
                      return `rgba(${r}, ${g}, ${b}, 0.6)`;
                  })
              }]
          },
          options: {
              responsive: true,
              plugins: {
                  tooltip: {
                      callbacks: {
                          label: function(context) {
                              let index = context.dataIndex;
                              return maxEditors[index] + ': ' + context.parsed.y + ' Artikel';
                          }
                      }
                  },
                  legend: { display: false }
              },
              scales: { y: { beginAtZero: true } }
          }
      });
      */
      
      // -------------------------------
      // Build Authors Network Graph
      // -------------------------------
      // Process articles: Split comma-separated author names and form unique pairs.
      const networkEdgesMap = {};
      const networkNodesSet = new Set();
      articles.forEach(row => {
          if (row.author) {
              let authorsList = filterAuthors(row.author);
              authorsList.forEach(a => networkNodesSet.add(a));
              for (let i = 0; i < authorsList.length; i++) {
                  for (let j = i + 1; j < authorsList.length; j++) {
                      let [a, b] = [authorsList[i], authorsList[j]].sort();
                      let key = a + '---' + b;
                      networkEdgesMap[key] = (networkEdgesMap[key] || 0) + 1;
                  }
              }
          }
      });
      const networkNodes = Array.from(networkNodesSet).map(author => ({ id: author, label: author }));
      const networkEdges = Object.entries(networkEdgesMap).map(([key, count]) => {
          let [from, to] = key.split('---');
          return { from, to, value: count, label: String(count) };
      });
      var container = document.getElementById('authorNetwork');
      var dataNetwork = {
          nodes: new vis.DataSet(networkNodes),
          edges: new vis.DataSet(networkEdges)
      };
      var optionsNetwork = {
          edges: { scaling: { label: true }, smooth: true },
          physics: {
              repulsion: {
                  centralGravity: 0.2,
                  springLength: 250,   // Erhöht den Abstand
                  springConstant: 0.05,
                  nodeDistance: 300    // Erhöht den minimalen Abstand zwischen Knoten
              },
              stabilization: { iterations: 250 }
          }
      };
      new vis.Network(container, dataNetwork, optionsNetwork);
      
      // Neues Diagramm: Top Autor pro Kategorie
      // Iterate over articles to collect author counts per category.
      const categoryAuthorCounts = {};
      articles.forEach(row => {
          if(row.category && row.author){
              // Split author field if multiple names are present.
              const authorList = filterAuthors(row.author);
              if (authorList.length > 0) {
                  authorList.forEach(author => {
                      if (!categoryAuthorCounts[row.category]) {
                          categoryAuthorCounts[row.category] = {};
                      }
                      categoryAuthorCounts[row.category][author] = 
                          (categoryAuthorCounts[row.category][author] || 0) + 1;
                  });
              }
          }
      });
      
      // For each category, find the author with the maximum count.
      const topCategories = [];
      const topAuthors = [];
      const topCounts = [];
      Object.keys(categoryAuthorCounts).forEach(cat => {
          let maxCount = 0, maxAuthor = "";
          Object.entries(categoryAuthorCounts[cat]).forEach(([author, count]) => {
              if(count > maxCount){
                  maxCount = count;
                  maxAuthor = author;
              }
          });
          topCategories.push(cat);
          topAuthors.push(maxAuthor);
          topCounts.push(maxCount);
      });
      
      // Create a bar chart for top authors per category.
      const ctxTopAuthor = document.getElementById('topAuthorChart').getContext('2d');
      new Chart(ctxTopAuthor, {
          type: 'bar',
          data: {
              labels: topCategories,
              datasets: [{
                  label: 'Anzahl Artikel (Top Autor)',
                  data: topCounts,
                  backgroundColor: topCategories.map(() => {
                      const r = Math.floor(Math.random()*156) + 100;
                      const g = Math.floor(Math.random()*156) + 100;
                      const b = Math.floor(Math.random()*156) + 100;
                      return `rgba(${r}, ${g}, ${b}, 0.6)`;
                  })
              }]
          },
          options: {
              responsive: true,
              plugins: {
                  tooltip: {
                      callbacks: {
                          label: function(context){
                              let idx = context.dataIndex;
                              return topAuthors[idx] + ': ' + context.parsed.y + ' Artikel';
                          }
                      }
                  },
                  legend: { display: false }
              },
              scales: {
                  y: { beginAtZero: true }
              }
          }
      });
      
    </script>
    
  </body>
</html>