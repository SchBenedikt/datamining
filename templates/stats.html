<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <title>Datenbank Statistik – Übersicht</title>
    <!-- Bootstrap CSS (v4.5) -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- DataTables Bootstrap4 CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
    <!-- Custom CSS -->
    <style>
      body {
        padding-top: 70px; 
        background: #f8f9fa;
      }
      /* Navbar with gradient and shadow */
      .navbar {
        background: linear-gradient(45deg, #007bff, #00c6ff);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .navbar-brand, .nav-link {
        font-weight: bold;
        color: #fff !important;
      }
      .navbar-brand:hover, .nav-link:hover {
        color: #ffd700 !important;
      }
      /* Card styling with subtle shadow and transition */
      .card {
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        transition: transform 0.2s;
      }
      .card:hover {
        transform: translateY(-3px);
      }
      .chart-container {
        height:50vh;
        width:90vw;
        margin: auto;
      }
      table th, table td {
        text-align: center;
      }
      table th.missing {
        font-size: 0.8rem;
        color: red;
      }
    </style>
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
      <a class="navbar-brand" href="#">DB Statistik</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" 
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="/stats">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/delete_table">Tabelle löschen</a>
          </li>
        </ul>
      </div>
    </nav>
    
    <div class="container-fluid">
      <h1 class="mb-4 text-center">Datenbank Statistik</h1>
      
      <!-- Prominente Anzeige der Gesamtzeilen (Artikel) -->
      <div class="card mb-4">
        <div class="card-body text-center">
          <h1 class="display-4 text-primary">
            Alle gecrawlten Artikel: {{ quality_stats['articles'].total }}
          </h1>
        </div>
      </div>
      
      <!-- New Chart: Top Autoren pro Kategorie (Artikel) -->
      <div class="card mb-4">
        <div class="card-header">
          Top Autoren pro Kategorie (Artikel)
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="authorCategoryChart"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Tabelle für alle Daten -->
      {% for table_name, rows in data.items() %}
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <h2 class="h5 mb-0">{{ table_name }}</h2>
              {% set quality = quality_stats[table_name] %}
              <small>Gesamte Zeilen: {{ quality.total }}</small>
            </div>
            <form method="POST" action="/delete_table" onsubmit="return confirm('Möchten Sie die Tabelle {{ table_name }} wirklich löschen?');">
              <input type="hidden" name="table_name" value="{{ table_name }}">
              <button type="submit" class="btn btn-danger btn-sm">Tabelle löschen</button>
            </form>
          </div>
          <div class="card-body">
            {% if rows %}
              <div class="table-responsive">
                <table class="table table-striped table-bordered datatable">
                  <thead>
                    <tr>
                      {% for col in rows[0].keys() %}
                        <th class="missing">Fehlend: {{ quality.missing[col] }}</th>
                      {% endfor %}
                    </tr>
                    <tr>
                      {% for col in rows[0].keys() %}
                        <th>{{ col }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in rows %}
                      <tr>
                        {% for col in row.values() %}
                          <td>{{ col }}</td>
                        {% endfor %}
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p>Keine Einträge vorhanden.</p>
            {% endif %}
          </div>
        </div>
      {% endfor %}
      
    </div>
    
    <!-- JS: jQuery, Popper, Bootstrap, DataTables and Chart.js -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      $(document).ready(function() {
        $('table.datatable').DataTable({
          ordering: true,
          paging: true
        });
      });
      
      // Aggregate articles data (from table "articles") for grouping by author and category
      const articles = {{ data.articles | tojson }};
      
      let authorsSet = new Set();
      let categoriesSet = new Set();
      articles.forEach(row => {
        if(row.author && row.category) {
          authorsSet.add(row.author);
          categoriesSet.add(row.category);
        }
      });
      let authors = Array.from(authorsSet);
      let categories = Array.from(categoriesSet);
      
      // Initialize count matrix: one array per category with counts per author
      let counts = {};
      categories.forEach(cat => {
        counts[cat] = new Array(authors.length).fill(0);
      });
      articles.forEach(row => {
        let author = row.author;
        let category = row.category;
        if(author && category) {
          counts[category][authors.indexOf(author)] += 1;
        }
      });
      
      // Create datasets for Chart.js (one dataset per category)
      let datasets = [];
      categories.forEach(cat => {
        const r = Math.floor(Math.random() * 156) + 100;
        const g = Math.floor(Math.random() * 156) + 100;
        const b = Math.floor(Math.random() * 156) + 100;
        datasets.push({
          label: cat,
          data: counts[cat],
          backgroundColor: `rgba(${r}, ${g}, ${b}, 0.6)`,
          borderColor: `rgba(${r}, ${g}, ${b}, 1)`,
          borderWidth: 1
        });
      });
      
      // Build the stacked bar chart
      const ctx = document.getElementById('authorCategoryChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: authors,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: { mode: 'index', intersect: false },
            legend: { position: 'top' }
          },
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true }
          }
        }
      });
    </script>
  </body>
</html>
