<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <title>Datenbank Statistik – Übersicht</title>
    <!-- Bootstrap CSS (v4.5) -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- DataTables Bootstrap4 CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
    <!-- Custom CSS -->
    <style>
      body {
        padding-top: 70px; 
        background: #f8f9fa;
      }
      /* Navbar with gradient and shadow */
      .navbar {
        background: linear-gradient(45deg, #007bff, #00c6ff);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .navbar-brand, .nav-link {
        font-weight: bold;
        color: #fff !important;
      }
      .navbar-brand:hover, .nav-link:hover {
        color: #ffd700 !important;
      }
      /* Card styling with subtle shadow and transition */
      .card {
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        transition: transform 0.2s;
      }
      .card:hover {
        transform: translateY(-3px);
      }
      .chart-container {
        height:50vh;
        width:90vw;
        margin: auto;
      }
      table th, table td {
        text-align: center;
      }
      table th.missing {
        font-size: 0.8rem;
        color: red;
      }
    </style>
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
      <a class="navbar-brand" href="#">DB Statistik</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" 
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="/stats">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/delete_table">Tabelle löschen</a>
          </li>
        </ul>
      </div>
    </nav>
    
    <div class="container-fluid">
      <h1 class="mb-4 text-center">Datenbank Statistik</h1>
      
      <!-- Integrity Status Field with Details Button -->
      <div id="integrityStatus" class="alert" role="alert">
        <!-- JavaScript will fill this in on page load -->
      </div>
      
      <!-- Error Details Modal -->
      <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title" id="errorModalLabel">Integritätsfehler Details</h5>
              <button type="button" class="close text-white" data-dismiss="modal" aria-label="Schließen">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body" id="errorDetails">
              <!-- Details populated by JS -->
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Prominente Anzeige der Gesamtzeilen (Artikel) -->
      <div class="card mb-4">
        <div class="card-body text-center">
          <h1 class="display-4 text-primary">
            Alle gecrawlten Artikel: {{ quality_stats['articles'].total }}
          </h1>
        </div>
      </div>
      
      <!-- New Chart: Top Autoren pro Kategorie (Artikel) -->
      <div class="card mb-4">
        <div class="card-header">
          Top Autoren pro Kategorie (Artikel)
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="authorCategoryChart"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Tabelle für alle Daten -->
      {% for table_name, rows in data.items() %}
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <h2 class="h5 mb-0">{{ table_name }}</h2>
              {% set quality = quality_stats[table_name] %}
              <small>Gesamte Zeilen: {{ quality.total }}</small>
            </div>
            <form method="POST" action="/delete_table" onsubmit="return confirm('Möchten Sie die Tabelle {{ table_name }} wirklich löschen?');">
              <input type="hidden" name="table_name" value="{{ table_name }}">
              <button type="submit" class="btn btn-danger btn-sm">Tabelle löschen</button>
            </form>
          </div>
          <div class="card-body">
            {% if rows %}
              <div class="table-responsive">
                <table class="table table-striped table-bordered datatable">
                  <thead>
                    <tr>
                      {% for col in rows[0].keys() %}
                        <th class="missing">Fehlend: {{ quality.missing[col] }}</th>
                      {% endfor %}
                    </tr>
                    <tr>
                      {% for col in rows[0].keys() %}
                        <th>{{ col }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in rows %}
                      <tr>
                        {% for col in row.values() %}
                          <td>{{ col }}</td>
                        {% endfor %}
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p>Keine Einträge vorhanden.</p>
            {% endif %}
          </div>
        </div>
      {% endfor %}
      
    </div>
    
    <!-- JS: jQuery, Popper, Bootstrap, DataTables and Chart.js -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      $(document).ready(function() {
        $('table.datatable').DataTable({
          ordering: true,
          paging: true
        });
      });
      
      // Integrity Check via JavaScript:
      window.addEventListener('load', function() {
        let integrityMessages = [];
        let detailedMessages = []; // For modal details
        // Use combination of title and date to check uniqueness.
        const articles = {{ data.articles | tojson }};
        if (articles && articles.length > 0) {
          let titleDateArray = articles.map(a => a.title + '|' + (a.date ? a.date : ''));
          let uniqueTitleDates = new Set(titleDateArray);
          if (titleDateArray.length !== uniqueTitleDates.size) {
            integrityMessages.push("Warnung: Duplikate erkennen (gleicher Titel und Datum) gefunden.");
            // Identify duplicates:
            let duplicates = titleDateArray.filter((item, index) => titleDateArray.indexOf(item) !== index);
            detailedMessages.push("Duplizierte Titel+Daten: " + Array.from(new Set(duplicates)).join(", "));
          }
          let validDates = articles.filter(a => a.date && a.date !== "N/A");
          if(validDates.length === 0) {
            integrityMessages.push("Warnung: Keine gültigen Veröffentlichungsdaten gefunden.");
            detailedMessages.push("Es wurden keine Artikel mit gültigen Datumsangaben gefunden.");
          }
        } else {
          integrityMessages.push("Warnung: Keine Artikeldaten vorhanden.");
          detailedMessages.push("Die Artikeldaten konnten nicht geladen werden.");
        }
        
        let statusDiv = document.getElementById('integrityStatus');
        if (integrityMessages.length > 0) {
          statusDiv.className = "alert alert-danger";
          statusDiv.innerHTML = integrityMessages.join("<br>") +
            '<br><button id="showDetailsBtn" class="btn btn-sm btn-outline-light mt-2">Fehlerdetails anzeigen</button>';
          // Attach click event for the details button
          document.getElementById('showDetailsBtn').addEventListener('click', function() {
            document.getElementById('errorDetails').innerHTML = detailedMessages.join("<br>");
            $('#errorModal').modal('show');
          });
        } else {
          statusDiv.className = "alert alert-success";
          statusDiv.innerHTML = "Alle Integritätstests erfolgreich.";
        }
      });
      
      // Build the stacked bar chart for Top Autoren pro Kategorie
      const authorsSet = new Set();
      const categoriesSet = new Set();
      const articles = {{ data.articles | tojson }};
      
      articles.forEach(row => {
        if(row.author && row.category) {
          authorsSet.add(row.author);
          categoriesSet.add(row.category);
        }
      });
      const authors = Array.from(authorsSet);
      const categories = Array.from(categoriesSet);
      
      // Initialize count matrix
      const counts = {};
      categories.forEach(cat => {
        counts[cat] = new Array(authors.length).fill(0);
      });
      articles.forEach(row => {
        const author = row.author;
        const category = row.category;
        if(author && category) {
          counts[category][authors.indexOf(author)] += 1;
        }
      });
      
      // Create datasets for Chart.js
      const datasets = [];
      categories.forEach(cat => {
        const r = Math.floor(Math.random() * 156) + 100;
        const g = Math.floor(Math.random() * 156) + 100;
        const b = Math.floor(Math.random() * 156) + 100;
        datasets.push({
          label: cat,
          data: counts[cat],
          backgroundColor: `rgba(${r}, ${g}, ${b}, 0.6)`,
          borderColor: `rgba(${r}, ${g}, ${b}, 1)`,
          borderWidth: 1
        });
      });
      
      const ctx = document.getElementById('authorCategoryChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: authors,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: { mode: 'index', intersect: false },
            legend: { position: 'top' }
          },
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true }
          }
        }
      });
    </script>
    
  </body>
</html>
